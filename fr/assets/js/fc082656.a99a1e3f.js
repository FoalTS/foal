"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[8847],{28453:(e,t,r)=>{r.d(t,{R:()=>i,x:()=>l});var n=r(96540);const a={},s=n.createContext(a);function i(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),n.createElement(s.Provider,{value:t},e.children)}},65584:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"tutorials/real-world-example-with-react/tuto-12-file-upload","title":"T\xe9l\xe9chargement d\'Images","description":"L\'\xe9tape suivante de ce tutoriel consiste \xe0 permettre aux utilisateurs de t\xe9l\xe9charger une photo de profil. Cette image sera affich\xe9e sur la page d\'accueil en face de chaque post de chaque auteur.","source":"@site/i18n/fr/docusaurus-plugin-content-docs/current/tutorials/real-world-example-with-react/12-file-upload.md","sourceDirName":"tutorials/real-world-example-with-react","slug":"/tutorials/real-world-example-with-react/12-file-upload","permalink":"/fr/docs/tutorials/real-world-example-with-react/12-file-upload","draft":false,"unlisted":false,"editUrl":"https://github.com/FoalTS/foal/edit/master/docs/docs/tutorials/real-world-example-with-react/12-file-upload.md","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{"title":"T\xe9l\xe9chargement d\'Images","id":"tuto-12-file-upload","slug":"12-file-upload"},"sidebar":"someSidebar","previous":{"title":"Ajout de la Page d\'Inscription","permalink":"/fr/docs/tutorials/real-world-example-with-react/11-sign-up"},"next":{"title":"Protection CSRF","permalink":"/fr/docs/tutorials/real-world-example-with-react/13-csrf"}}');var a=r(74848),s=r(28453);const i={title:"T\xe9l\xe9chargement d'Images",id:"tuto-12-file-upload",slug:"12-file-upload"},l=void 0,o={},d=[{value:"C\xf4t\xe9 serveur",id:"c\xf4t\xe9-serveur",level:2},{value:"C\xf4t\xe9 client",id:"c\xf4t\xe9-client",level:2}];function c(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"L'\xe9tape suivante de ce tutoriel consiste \xe0 permettre aux utilisateurs de t\xe9l\xe9charger une photo de profil. Cette image sera affich\xe9e sur la page d'accueil en face de chaque post de chaque auteur."}),"\n",(0,a.jsxs)(t.p,{children:["Pour ce faire, vous utiliserez le syst\xe8me de stockage de Foal. Il vous permet de valider et d'enregistrer les fichiers t\xe9l\xe9charg\xe9s par le client. Ces fichiers peuvent \xeatre sauvegard\xe9s sur votre disque local ou dans le Cloud en utilisant AWS S3. Nous n'utiliserons pas la fonction \"cloud\" dans ce tutoriel, mais vous pouvez d\xe9couvrir comment la configurer ",(0,a.jsx)(t.a,{href:"/fr/docs/common/file-storage/local-and-cloud-storage",children:"ici"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"c\xf4t\xe9-serveur",children:"C\xf4t\xe9 serveur"}),"\n",(0,a.jsx)(t.p,{children:"Tout d'abord, installez le paquet."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm install @foal/storage\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Mettez \xe0 jour la configuration dans ",(0,a.jsx)(t.code,{children:"config/default.json"})," pour sp\xe9cifier l'emplacement des fichiers auxquels le gestionnaire de disque peut acc\xe9der."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-json",children:'{\n  "port": "env(PORT)",\n  "settings": {\n    ...\n    "disk": {\n      "local": {\n        "directory": "assets"\n      }\n    }\n  },\n  ...\n}\n'})}),"\n",(0,a.jsxs)(t.p,{children:["Cr\xe9ez ensuite le r\xe9pertoire ",(0,a.jsx)(t.code,{children:"assets/images/profiles/uploaded"})," o\xf9 les images de profil seront t\xe9l\xe9charg\xe9es. T\xe9l\xe9chargez l'image de profil par d\xe9faut ",(0,a.jsx)(t.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(80352).A+"",children:"ici"})," et placez-la dans le dossier ",(0,a.jsx)(t.code,{children:"assets/images/profiles"})," avec le nom ",(0,a.jsx)(t.code,{children:"default.png"}),"."]}),"\n",(0,a.jsx)(t.p,{children:"Vous \xeates pr\xeat \xe0 cr\xe9er le contr\xf4leur. G\xe9n\xe9rez-en un nouveau."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"foal generate controller api/profile --register\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Ouvrez le nouveau fichier ",(0,a.jsx)(t.code,{children:"profile.controller.ts"})," et ajoutez deux nouvelles routes."]}),"\n",(0,a.jsxs)(t.table,{children:[(0,a.jsx)(t.thead,{children:(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.th,{children:"Point de terminaison"}),(0,a.jsx)(t.th,{children:"M\xe9thode"}),(0,a.jsx)(t.th,{children:"Description"})]})}),(0,a.jsxs)(t.tbody,{children:[(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:"/api/profile/avatar"})}),(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:"GET"})}),(0,a.jsxs)(t.td,{children:["R\xe9cup\xe8re l'image de profil de l'utilisateur. Si le param\xe8tre de requ\xeate facultatif ",(0,a.jsx)(t.code,{children:"userId"})," est fourni, le serveur renvoie l'avatar de cet utilisateur. Sinon, il renvoie l'avatar de l'utilisateur actuel. Si aucun utilisateur n'est authentifi\xe9 ou s'il ou elle n'a pas d'image de profil, une image par d\xe9faut est renvoy\xe9e."]})]}),(0,a.jsxs)(t.tr,{children:[(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:"/api/profile"})}),(0,a.jsx)(t.td,{children:(0,a.jsx)(t.code,{children:"POST"})}),(0,a.jsxs)(t.td,{children:["Met \xe0 jour le profil de l'utilisateur. Un champ ",(0,a.jsx)(t.code,{children:"name"})," et un fichier ",(0,a.jsx)(t.code,{children:"avatar"})," facultatif sont attendus."]})]})]})]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-typescript",children:"import { Context, dependency, File, Get, HttpResponseNoContent, Post, UserRequired, ValidateQueryParam } from '@foal/core';\nimport { Disk, ParseAndValidateFiles } from '@foal/storage';\nimport { User } from '../../entities';\n\nexport class ProfileController {\n  @dependency\n  disk: Disk;\n\n  @Get('/avatar')\n  @ValidateQueryParam('userId', { type: 'number' }, { required: false })\n  async readProfileImage(ctx: Context<User|null>) {\n    let user = ctx.user;\n\n    const userId: number|undefined = ctx.request.query.userId;\n    if (userId !== undefined) {\n      user = await User.findOneBy({ id: userId })\n    }\n\n    if (!user || !user.avatar) {\n      return this.disk.createHttpResponse('images/profiles/default.png');\n    }\n\n    return this.disk.createHttpResponse(user.avatar);\n  }\n\n  @Post()\n  @UserRequired()\n  @ParseAndValidateFiles(\n    {\n      avatar: { required: false, saveTo: 'images/profiles/uploaded' }\n    },\n    {\n      type: 'object',\n      properties: {\n        name: { type: 'string', maxLength: 255 }\n      },\n      required: ['name']\n    }\n  )\n  async updateProfileImage(ctx: Context<User>) {\n    ctx.user.name = ctx.request.body.name;\n\n    // Warning: File must be imported from `@foal/core`.\n    const file: File|undefined = ctx.files.get('avatar')[0];\n    if (file) {\n      if (ctx.user.avatar) {\n        await this.disk.delete(ctx.user.avatar);\n      }\n      ctx.user.avatar = file.path;\n    }\n\n    await ctx.user.save();\n\n    return new HttpResponseNoContent();\n  }\n\n}\n\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Allez sur ",(0,a.jsx)(t.a,{href:"http://localhost:3001/swagger",children:"http://localhost:3001/swagger"})," et essayez de t\xe9l\xe9charger une photo de profil. Vous devez d'abord vous connecter."]}),"\n",(0,a.jsxs)(t.blockquote,{children:["\n",(0,a.jsxs)(t.p,{children:["Vous avez peut-\xeatre remarqu\xe9 le d\xe9corateur ",(0,a.jsx)(t.code,{children:"@dependency"})," pour d\xe9finir la propri\xe9t\xe9 ",(0,a.jsx)(t.code,{children:"disk: Disk"}),". Ce m\xe9canisme est appel\xe9 injection de d\xe9pendance et est particuli\xe8rement utile dans les tests unitaires. Vous pouvez en savoir plus \xe0 ce sujet ",(0,a.jsx)(t.a,{href:"/fr/docs/architecture/architecture-overview",children:"ici"}),"."]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"c\xf4t\xe9-client",children:"C\xf4t\xe9 client"}),"\n",(0,a.jsxs)(t.p,{children:["Du c\xf4t\xe9 client, le t\xe9l\xe9chargement de l'image du profil est g\xe9r\xe9 dans les fichiers ",(0,a.jsx)(t.code,{children:"ProfileHeader.tsx"})," et ",(0,a.jsx)(t.code,{children:"requests/profile.ts"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["Ouvrez ce dernier et impl\xe9mentez la fonction ",(0,a.jsx)(t.code,{children:"updateProfile"}),"."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-typescript",children:"import axios from 'axios';\n\nexport async function updateProfile(username: string, avatar: File|null): Promise<void> {\n  const formData = new FormData();\n  formData.set('name', username);\n  if (avatar) {\n    formData.set('avatar', avatar);\n  }\n\n  await axios.post('/api/profile', formData, {\n    headers: {\n    'content-type': 'multipart/form-data'\n    }\n  });\n}\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Maintenant, si vous retournez sur ",(0,a.jsx)(t.a,{href:"http://localhost:3000/profile",children:"http://localhost:3000/profile"}),", vous devriez pouvoir t\xe9l\xe9charger votre photo de profil."]})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},80352:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/files/default-9490f4915bf9aca8c77fd98e411f2e2c.png"}}]);