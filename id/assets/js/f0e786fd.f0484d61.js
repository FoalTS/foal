"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1113],{12382:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>l});var c=s(74848),o=s(28453);const r={title:"Async tasks"},t=void 0,i={id:"common/async-tasks",title:"Async tasks",description:"Running an asynchronous task",source:"@site/i18n/id/docusaurus-plugin-content-docs/current/common/async-tasks.md",sourceDirName:"common",slug:"/common/async-tasks",permalink:"/id/docs/common/async-tasks",draft:!1,unlisted:!1,editUrl:"https://github.com/FoalTS/foal/edit/master/docs/docs/common/async-tasks.md",tags:[],version:"current",frontMatter:{title:"Async tasks"},sidebar:"someSidebar",previous:{title:"Logging",permalink:"/id/docs/common/logging"},next:{title:"REST API",permalink:"/id/docs/common/rest-blueprints"}},a={},l=[{value:"Running an asynchronous task",id:"running-an-asynchronous-task",level:2},{value:"Scheduling a job",id:"scheduling-a-job",level:2},{value:"Example",id:"example",level:3},{value:"Background Jobs with pm2",id:"background-jobs-with-pm2",level:3}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.h2,{id:"running-an-asynchronous-task",children:"Running an asynchronous task"}),"\n",(0,c.jsx)(n.p,{children:"In some situations, we need to execute a specific task without waiting for it and without blocking the request."}),"\n",(0,c.jsx)(n.p,{children:"This could be, for example, sending a specific message to the CRM or company chat. In this case, the user needs to be able to see his or her request completed as quickly as possible, even if the request to the CRM takes some time or fails."}),"\n",(0,c.jsxs)(n.p,{children:["To this end, Foal provides an ",(0,c.jsx)(n.code,{children:"AsyncService"})," to execute these tasks asynchronously, and correctly catch and log their errors where appropriate."]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"import { AsyncService, dependency } from '@foal/core';\n\nimport { CRMService } from './somewhere';\n\nexport class SubscriptionService {\n  @dependency\n  asyncService: AsyncService;\n\n  @dependency\n  crmService: CRMService;\n\n  async subscribe(userId: number): Promise<void> {\n    // Do something\n\n    this.asyncService.run(() => this.crmService.updateUser(userId));\n  }\n}\n\n"})}),"\n",(0,c.jsx)(n.h2,{id:"scheduling-a-job",children:"Scheduling a job"}),"\n",(0,c.jsxs)(n.p,{children:["You can schedule jobs using ",(0,c.jsx)(n.a,{href:"/id/docs/cli/shell-scripts",children:"shell scripts"})," and the ",(0,c.jsx)(n.a,{href:"https://www.npmjs.com/package/node-schedule",children:"node-schedule"})," library."]}),"\n",(0,c.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.em,{children:"scripts/fetch-metrics.ts"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"export function main(args: any) {\n  // Do some stuff\n}\n\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.em,{children:"scripts/schedule-jobs.ts"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"// 3p\nimport { scheduleJob } from 'node-schedule';\nimport { main as fetchMetrics } from './fetch-metrics';\n\nexport async function main(args: any) {\n  console.log('Scheduling the job...');\n\n  // Run the fetch-metrics script every day at 10:00 AM.\n  scheduleJob(\n    { hour: 10, minute: 0 },\n    () => fetchMetrics(args)\n  );\n\n  console.log('Job scheduled!');\n}\n\n"})}),"\n",(0,c.jsx)(n.p,{children:"Schedule the job(s):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-sh",children:"npm run build\nnpx foal run schedule-jobs arg1=value1\n"})}),"\n",(0,c.jsx)(n.h3,{id:"background-jobs-with-pm2",children:"Background Jobs with pm2"}),"\n",(0,c.jsxs)(n.p,{children:["While the above command works, it does not run the scheduler and the jobs in the background. To do this, you can use ",(0,c.jsx)(n.a,{href:"http://pm2.keymetrics.io/",children:"pm2"}),", a popular process manager for Node.js."]}),"\n",(0,c.jsxs)(n.p,{children:["First you need to install ",(0,c.jsx)(n.em,{children:"locally"})," the Foal CLI:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"npm install @foal/cli\n"})}),"\n",(0,c.jsx)(n.p,{children:"Then you can run the scheduler like this:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-sh",children:"pm2 start ./node_modules/.bin/foal --name scheduler -- run schedule-jobs arg1=value1\n"})}),"\n",(0,c.jsx)(n.p,{children:"If everything works fine, you should see your scheduler running with this command:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-sh",children:"pm2 ls\n"})}),"\n",(0,c.jsx)(n.p,{children:"To display the logs of the scheduler and the jobs, use this one:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"pm2 logs scheduler\n"})}),"\n",(0,c.jsx)(n.p,{children:"Eventually, to stop the scheduler and the jobs, you can use this command:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"pm2 delete scheduler\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>i});var c=s(96540);const o={},r=c.createContext(o);function t(e){const n=c.useContext(r);return c.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),c.createElement(r.Provider,{value:n},e.children)}}}]);